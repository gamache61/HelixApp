<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
<title>Helix v47.5 - Vision & Persistent Mic</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='black'/><circle cx='50' cy='50' r='40' stroke='cyan' stroke-width='5' fill='none'/><text x='50' y='65' font-family='sans-serif' font-size='50' fill='cyan' text-anchor='middle'>H</text></svg>">

<style>
  body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
  #scene { height: 25%; min-height: 140px; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); border-bottom: 1px solid #333; position: relative; }
  #core { width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #fff, #0ff, #001); border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; transition: 0.3s; z-index: 2; animation: float 6s ease-in-out infinite; }
  #core span { font-size: 10px; font-weight: 900; letter-spacing: 1px; color: rgba(0,0,0,0.6); font-family: monospace; pointer-events: none; }
  
  #core.listening { background: radial-gradient(circle at 30% 30%, #fff, #5f5, #010) !important; box-shadow: 0 0 60px lime !important; transform: scale(1.1); }
  #core.thinking { background: radial-gradient(circle at 30% 30%, #fff, #fb0, #420) !important; box-shadow: 0 0 50px orange !important; animation: pulseFast 0.5s alternate infinite !important; }
  #core.talking { background: radial-gradient(circle at 30% 30%, #fff, #a0f, #205) !important; box-shadow: 0 0 60px #a0f !important; animation: pulse 0.3s alternate infinite !important; }
  
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.08); } }
  @keyframes pulseFast { 0% { transform: scale(0.95); opacity: 0.8; } 100% { transform: scale(1.0); opacity: 1; } }

  #camera-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; flex-direction: column; }
  video { width: 100%; height: 100%; object-fit: cover; }
  #cam-ui { position: absolute; bottom: 40px; width: 100%; text-align: center; }

  #ui-layer { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #0a0a0a; gap: 10px; overflow: hidden; position: relative; }
  #header-row { display: flex; justify-content: space-between; align-items: center; }
  #model-badge { background: #112; color: #aaf; border: 1px solid #336; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; font-family: monospace; }
  
  #console { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #222; border-radius: 8px; background: #000; display: flex; flex-direction: column; gap: 10px; }
  .msg { padding: 10px; border-radius: 8px; font-size: 15px; max-width: 90%; line-height: 1.4; word-wrap: break-word; }
  .user { align-self: flex-end; background: #222; color: #fff; }
  .ai { align-self: flex-start; color: #ccc; border: 1px solid #333; width: 100%; }
  .system { align-self: center; font-size: 11px; color: #555; }
  .code-block { background: #111; padding: 10px; margin-top:5px; border-radius:6px; font-family:monospace; font-size:12px; overflow-x:auto; border:1px solid #333; color: #0f0; white-space: pre-wrap; }

  #settings-panel { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; flex-direction: column; align-items: center; padding: 30px; box-sizing: border-box; overflow-y: auto; }
  #settings-panel.active { display: flex !important; }
  .setting-label { color:#888; font-size:12px; margin-top:15px; font-weight:bold; width: 100%; }
  .key-input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #444; background: #111; color: white; margin-top: 5px; font-family: monospace; text-align: center; }
  #save-btn { width: 100%; padding: 20px; background: cyan; color: #000; border: none; border-radius: 10px; font-weight: bold; margin-top: 20px; }

  #controls { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
  #image-preview { display: none; width: 60px; height: 60px; border-radius: 8px; border: 2px solid cyan; background-size: cover; margin-bottom: 5px; }
  #input-row { display: flex; gap: 8px; align-items: center; }
  #txt-input { flex-grow: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #111; color: white; font-size: 16px; outline: none; }
  .action-btn { background: #222; color: #aaa; border: 1px solid #333; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  #mic-btn.active { background: #060; border-color: lime; color: #fff; box-shadow: 0 0 15px #060; }
  #action-row { display: flex; gap: 8px; }
  .sub-btn { flex: 1; padding: 10px; background: #111; border: 1px solid #333; color: #888; border-radius: 8px; font-size: 12px; }
</style>
</head>
<body>

<div id="settings-panel">
    <h2 style="color:cyan; font-family:monospace;">HELIX CONFIG</h2>
    <div class="setting-label">Gemini Model</div>
    <select id="model-select" class="key-input">
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
    </select>
    <div class="setting-label">Google API Key</div>
    <input type="text" id="google-key-input" class="key-input" placeholder="AIza...">
    <div class="setting-label">ElevenLabs API Key</div>
    <input type="text" id="eleven-key-input" class="key-input" placeholder="Voice Key...">
    <button id="save-btn" onclick="saveSettings()">SAVE & START</button>
</div>

<div id="camera-container">
    <video id="cam-feed" autoplay playsinline></video>
    <div id="cam-ui">
        <button class="action-btn" onclick="snapPhoto()" style="width: 80px; height: 80px; border-radius: 50%; background: white; margin: 0 auto; border: 5px solid #333;"></button>
        <p style="color:white; margin-top:10px;">TAP TO CAPTURE CODE</p>
    </div>
</div>

<div id="scene">
    <div id="core"><span id="orb-text">HELIX</span></div>
</div>

<div id="ui-layer">
  <div id="header-row">
    <div id="model-badge">READY</div>
    <button class="sub-btn" style="max-width: 60px;" onclick="toggleSettings()">âš™</button>
  </div>

  <div id="console"></div>
    
  <div id="controls">
    <div id="image-preview" onclick="clearImage()"></div>
    <div id="input-row">
        <input id="txt-input" placeholder="Message or scan code..." onkeydown="if(event.key==='Enter') sendText()">
        <button id="mic-btn" class="action-btn" onclick="handleMicClick()">ðŸŽ¤</button>
        <button id="send-btn" class="action-btn" onclick="sendText()" style="color:cyan;">â–¶</button>
    </div>
    <div id="action-row">
        <button class="sub-btn" onclick="startCamera()">ðŸ“· CAMERA SCAN</button>
        <button class="sub-btn" onclick="clearConversation()">ðŸ—‘ CLEAR</button>
    </div>
  </div>
</div>

<canvas id="cam-canvas" style="display:none;"></canvas>

<script>
let googleKey = localStorage.getItem('helix_google_key_v47') || "";
let elevenKey = localStorage.getItem('helix_eleven_key_v47') || "";
let currentModel = localStorage.getItem('helix_model_v47') || "gemini-2.0-flash";
let isSpeaking = false, micEnabled = false, recognition = null, videoStream = null;
let currentImage = null, currentMime = "image/jpeg";

// Initialize Mic
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.onstart = () => { updateOrb('listening', 'LISTENING'); document.getElementById('mic-btn').classList.add('active'); };
    recognition.onend = () => { if(micEnabled) recognition.start(); else { document.getElementById('mic-btn').classList.remove('active'); updateOrb('', 'HELIX'); } };
    recognition.onresult = (e) => { 
        let t = e.results[e.results.length-1][0].transcript;
        if(e.results[e.results.length-1].isFinal) { document.getElementById('txt-input').value = t; sendText(); }
    };
}

window.onload = () => { if(!googleKey) toggleSettings(); updateBadge(); };

function toggleSettings() { document.getElementById('settings-panel').classList.toggle('active'); document.getElementById('google-key-input').value = googleKey; document.getElementById('eleven-key-input').value = elevenKey; }
function saveSettings() {
    googleKey = document.getElementById('google-key-input').value.trim();
    elevenKey = document.getElementById('eleven-key-input').value.trim();
    currentModel = document.getElementById('model-select').value;
    localStorage.setItem('helix_google_key_v47', googleKey);
    localStorage.setItem('helix_eleven_key_v47', elevenKey);
    localStorage.setItem('helix_model_v47', currentModel);
    toggleSettings(); updateBadge();
}
function updateBadge() { document.getElementById('model-badge').innerText = currentModel.toUpperCase(); }

async function sendText() {
    const input = document.getElementById('txt-input');
    const text = input.value.trim();
    if(!text && !currentImage) return;

    input.value = "";
    addMessage('user', text || "[Scanned Image]");
    updateOrb('thinking', 'THINKING');

    try {
        let parts = [];
        if(text) parts.push({ text: text });
        if(currentImage) parts.push({ inline_data: { mime_type: currentMime, data: currentImage } });

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${googleKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ role: 'user', parts: parts }] })
        });

        const data = await res.json();
        
        // FIX FOR "UNDEFINED"
        if(data.error) throw new Error(data.error.message);
        const aiMsg = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI could not generate a response. Check your image quality.";

        clearImage();
        addMessage('ai', aiMsg);
        updateOrb(micEnabled ? 'listening' : '', micEnabled ? 'LISTENING' : 'HELIX');
        speak(aiMsg);
    } catch (e) {
        addMessage('system', "Error: " + e.message);
        updateOrb('', 'ERROR');
    }
}

async function speak(text) {
    let clean = text.replace(/```[\s\S]*?```/g, " code results ").replace(/[*#]/g, '').slice(0, 400);
    isSpeaking = true;
    if(elevenKey) {
        updateOrb('talking', 'SPEAKING');
        try {
            const res = await fetch("https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM", {
                method: "POST",
                headers: { "xi-api-key": elevenKey, "Content-Type": "application/json" },
                body: JSON.stringify({ text: clean, model_id: "eleven_turbo_v2_5" })
            });
            if(res.ok) {
                const audio = new Audio(URL.createObjectURL(await res.blob()));
                audio.onended = () => { isSpeaking = false; updateOrb(micEnabled ? 'listening' : '', micEnabled ? 'LISTENING' : 'HELIX'); };
                audio.play(); return;
            }
        } catch(e) {}
    }
    const u = new SpeechSynthesisUtterance(clean);
    u.onend = () => { isSpeaking = false; updateOrb(micEnabled ? 'listening' : '', micEnabled ? 'LISTENING' : 'HELIX'); };
    window.speechSynthesis.speak(u);
}

function handleMicClick() { if(!micEnabled) { micEnabled = true; recognition.start(); } else { micEnabled = false; recognition.stop(); } }
function updateOrb(c, t) { const o = document.getElementById('core'); o.className = c; document.getElementById('orb-text').innerText = t; }
function addMessage(r, t) {
    const c = document.getElementById('console');
    const m = document.createElement('div');
    m.className = 'msg ' + (r==='ai'?'ai':r==='user'?'user':'system');
    m.innerHTML = t.replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>');
    c.appendChild(m); c.scrollTop = c.scrollHeight;
}

// Camera Logic
function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
        videoStream = s; document.getElementById('cam-feed').srcObject = s;
        document.getElementById('camera-container').style.display = 'flex';
    });
}
function snapPhoto() {
    const v = document.getElementById('cam-feed'), c = document.getElementById('cam-canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    currentImage = c.toDataURL('image/jpeg').split(',')[1];
    document.getElementById('image-preview').style.backgroundImage = `url(${c.toDataURL('image/jpeg')})`;
    document.getElementById('image-preview').style.display = 'block';
    videoStream.getTracks().forEach(t => t.stop());
    document.getElementById('camera-container').style.display = 'none';
}
function clearImage() { currentImage = null; document.getElementById('image-preview').style.display = 'none'; }
function clearConversation() { document.getElementById('console').innerHTML = ''; }
</script>
</body>
</html>
