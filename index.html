<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>Helix SafeMode</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Banana_Icon.svg/1024px-Banana_Icon.svg.png">

<style>
  /* --- LAYOUT --- */
  body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
  
  /* --- VISUALS --- */
  #scene { height: 25%; min-height: 140px; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); border-bottom: 1px solid #333; position: relative; }
  #core { width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #fff, #0ff, #001); border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
  #core span { font-size: 10px; font-weight: 900; letter-spacing: 1px; color: rgba(0,0,0,0.6); font-family: monospace; pointer-events: none; }
  
  /* ANIMATIONS */
  #core.talking { background: #a0f; box-shadow: 0 0 60px #a0f; animation: pulse 0.3s alternate infinite; }
  #core.thinking { background: #fb0; box-shadow: 0 0 50px orange; transform: scale(0.95); }
  #core.listening { background: #5f5; box-shadow: 0 0 60px lime; transform: scale(1.15); }
  
  @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.08); } }

  /* --- SETTINGS BUTTON --- */
  #settings-btn { position: absolute; top: 10px; right: 10px; background: none; border: 1px solid #333; color: #555; font-size: 20px; cursor: pointer; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; z-index: 50; }

  /* --- UI --- */
  #console { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; background: #0a0a0a; }
  .msg { padding: 10px; border-radius: 8px; font-size: 15px; max-width: 90%; line-height: 1.4; word-wrap: break-word; }
  .user { align-self: flex-end; background: #222; color: #fff; }
  .ai { align-self: flex-start; color: #ccc; border: 1px solid #333; width: 100%; box-sizing: border-box; }
  .sys { align-self: center; font-size: 12px; color: #666; font-style: italic; margin: 5px 0; }

  /* --- INPUTS --- */
  #controls { display: flex; flex-direction: column; gap: 8px; padding: 10px; background: #0a0a0a; flex-shrink: 0; }
  #input-row { display: flex; gap: 8px; }
  #txt-input { flex-grow: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #111; color: white; outline: none; font-size: 16px; }
  button { background: #222; color: cyan; border: 1px solid #333; border-radius: 12px; font-size: 18px; padding: 0 15px; cursor: pointer; }
  #mic-btn { padding: 15px; width: 100%; font-weight: bold; color: white; font-size: 16px; transition: 0.2s; }
  #mic-btn.active { background: #060; border-color: lime; box-shadow: 0 0 15px #060; }
  
  /* --- KEY MODAL (The Black Box) --- */
  #key-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center; flex-direction: column; gap: 15px; }
  #key-modal h3 { color: cyan; font-family: monospace; letter-spacing: 2px; }
  #key-modal input { width: 80%; padding: 15px; background: #222; border: 1px solid #444; color: #fff; font-family: monospace; border-radius: 8px; font-size: 14px; outline: none; }
  #key-modal button { background: cyan; color: black; border: none; font-weight: bold; padding: 12px 30px; }
  #key-modal p { color: #888; font-size: 12px; max-width: 80%; text-align: center; line-height: 1.5; }
</style>
</head>
<body>

<div id="key-modal">
    <h3>HELIX SETUP</h3>
    <p>To enable the high-quality "Rachel" voice, paste your new ElevenLabs API Key below. It will be saved securely on your device.</p>
    <input id="key-input" placeholder="Paste key starting with sk_...">
    <button onclick="saveKey()">SAVE KEY</button>
    <button onclick="closeSettings()" style="background:transparent; color:#555; font-size:12px; margin-top:10px;">Cancel (Use Robot Voice)</button>
</div>

<div id="scene">
    <button id="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
    <div id="core"><span id="orb-text">HELIX</span></div>
</div>

<div id="console"></div>

<div id="controls">
    <div id="input-row">
        <input id="txt-input" placeholder="Type message..." onkeydown="if(event.key==='Enter') sendText()">
        <button onclick="sendText()">‚û§</button>
    </div>
    <button id="mic-btn" onclick="handleMicClick()">üéôÔ∏è TAP TO SPEAK</button>
</div>

<script>
// --- CONFIG ---
const googleKey = "AIzaSyCvi8rrW-p1G5ZKyFiVY48eAaggLRe4BMY".trim(); 
const voiceID = "21m00Tcm4TlvDq8ikWAM"; // Rachel Voice

// --- STATE ---
let elevenKey = localStorage.getItem("helix_eleven_key") || "";
let history = [];
let recognition = null;
let synth = window.speechSynthesis;
let isSpeaking = false;

// --- STARTUP CHECK ---
window.onload = () => {
    // Load history
    let savedHist = localStorage.getItem('helix_history_safe');
    if(savedHist) {
        history = JSON.parse(savedHist);
        history.forEach(h => addMessage(h.role, h.text, false));
    } else {
        addMessage('ai', "Helix Online.", false);
    }

    // Check Key
    if (!elevenKey || elevenKey.length < 10) {
        setTimeout(openSettings, 1000); // Ask for key after 1 second
    }
};

// --- SETTINGS LOGIC ---
function openSettings() { document.getElementById('key-modal').style.display = 'flex'; }
function closeSettings() { document.getElementById('key-modal').style.display = 'none'; }

function saveKey() {
    let k = document.getElementById('key-input').value.trim();
    if(k.length > 10) {
        localStorage.setItem("helix_eleven_key", k);
        elevenKey = k;
        document.getElementById('key-modal').style.display = 'none';
        alert("‚úÖ Key Saved!\nHelix will now use the Rachel voice.");
    } else {
        alert("‚ùå Invalid Key.\nPlease make sure you copied the full key starting with 'sk_'.");
    }
}

// --- VOICE ENGINE ---
async function speak(text) {
    if(!text) return;
    isSpeaking = true;
    updateOrb('talking');
    if(recognition) recognition.stop();

    // 1. Try ElevenLabs (if key exists)
    if (elevenKey) {
        try {
            console.log("Requesting ElevenLabs...");
            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceID}`, {
                method: "POST",
                headers: { "xi-api-key": elevenKey, "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    text: text.slice(0, 450), 
                    model_id: "eleven_multilingual_v2", 
                    voice_settings: { stability: 0.5, similarity_boost: 0.75 } 
                })
            });

            if(!response.ok) {
                if(response.status === 401) {
                    alert("‚ö†Ô∏è KEY EXPIRED/INVALID.\nPlease generate a new ElevenLabs key and update it in settings (‚öôÔ∏è).");
                    openSettings();
                } else if (response.status === 429) {
                    alert("‚ö†Ô∏è OUT OF CREDITS.\nYou have used all your ElevenLabs characters. Switching to robot voice.");
                } else {
                    console.warn("API Error", await response.text());
                }
                throw new Error("API_FAIL");
            }

            const audioBlob = await response.blob();
            const audio = new Audio(URL.createObjectURL(audioBlob));
            audio.onended = () => { isSpeaking = false; updateOrb(''); };
            await audio.play();
            return;

        } catch (e) { console.log("Falling back to robot"); }
    }

    // 2. Fallback: Robot Voice
    synth.cancel();
    let u = new SpeechSynthesisUtterance(text);
    u.rate = 1.1; 
    u.pitch = 1.0;
    u.onend = () => { isSpeaking = false; updateOrb(''); };
    synth.speak(u);
}

// --- CORE LOGIC ---
function updateOrb(state) {
    const orb = document.getElementById('core');
    orb.className = state; // 'talking', 'thinking', 'listening', or ''
}

async function sendText() {
    let input = document.getElementById('txt-input');
    let text = input.value.trim();
    if (!text) return;
    
    input.value = "";
    addMessage('user', text, true);
    updateOrb('thinking');
    
    try {
        let req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${googleKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                contents: [
                    ...history.slice(-10).map(h => ({ role: h.role === 'ai' ? 'model' : 'user', parts: [{ text: h.text }] })), 
                    { role: 'user', parts: [{ text: text }] }
                ] 
            })
        });
        
        let res = await req.json();
        
        if(res.error) throw new Error(res.error.message);
        
        let ans = res.candidates[0].content.parts[0].text;
        
        addMessage('ai', ans, true);
        speak(ans);
    } catch(e) {
        updateOrb('error');
        addMessage('sys', "Error: " + e.message, false);
        speak("I encountered an error.");
    }
}

function addMessage(role, text, save) {
    let d = document.createElement('div');
    if (role === 'sys') {
        d.className = 'sys'; d.innerText = text;
    } else {
        d.className = 'msg ' + role;
        d.innerHTML = text.replace(/\n/g, '<br>');
    }
    
    let c = document.getElementById('console');
    c.appendChild(d);
    c.scrollTop = c.scrollHeight;

    if(save && role !== 'sys') {
        history.push({ role: role, text: text });
        localStorage.setItem('helix_history_safe', JSON.stringify(history));
    }
}

// --- MICROPHONE ---
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'en-US';
    
    recognition.onstart = () => {
        updateOrb('listening');
        document.getElementById('mic-btn').classList.add('active');
        document.getElementById('mic-btn').innerText = "üõë LISTENING...";
    };

    recognition.onresult = (e) => { 
        const t = e.results[0][0].transcript; 
        if(t) { 
            document.getElementById('txt-input').value = t; 
            sendText(); 
        } 
    };
    
    recognition.onend = () => {
        document.getElementById('mic-btn').classList.remove('active');
        document.getElementById('mic-btn').innerText = "üéôÔ∏è TAP TO SPEAK";
        if(!isSpeaking) updateOrb('');
    };
}

function handleMicClick() {
    let u = new SpeechSynthesisUtterance(""); synth.speak(u); // Unlock audio
    if (!isSpeaking) {
        try { recognition.start(); } catch(e){}
    }
}
</script>
</body>
</html>