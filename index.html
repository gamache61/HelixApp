<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>Helix AI</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">

<style>
  /* --- RESET --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    background: #000; color: #fff; 
    font-family: -apple-system, BlinkMacSystemFont, monospace; 
    height: 100dvh; width: 100vw; margin: 0; padding: 0;
    display: flex; flex-direction: column; overflow: hidden; 
  }

  /* --- START SCREEN --- */
  #boot-screen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 9999;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  #start-btn {
    padding: 20px 40px; border: 2px solid #0f0; background: #002200; color: #0f0;
    font-size: 24px; font-weight: bold; border-radius: 12px; cursor: pointer;
    box-shadow: 0 0 20px #0f0; animation: pulse 1.5s infinite;
  }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

  /* --- HEADER --- */
  #header-row { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 15px; background: #111; border-bottom: 1px solid #333; flex-shrink: 0; 
    padding-top: max(15px, env(safe-area-inset-top)); 
  }
  
  button { font-family: monospace; font-weight: bold; cursor: pointer; }
  
  #key-btn { background: #222; border: 1px solid cyan; color: cyan; padding: 8px 15px; border-radius: 6px; }
  #reset-btn { background: #300; border: 1px solid red; color: red; padding: 8px 12px; border-radius: 6px; }

  /* --- SCENE --- */
  #scene { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
  #core { width: 120px; height: 120px; background: #fff; border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
  #core-text { color: rgba(0,0,0,0.7); font-weight: 900; font-size: 12px; letter-spacing: 2px; }
  
  /* STATES */
  .thinking { background: orange !important; box-shadow: 0 0 50px orange !important; transform: scale(0.9); }
  .talking { background: #a0f !important; box-shadow: 0 0 80px #a0f !important; transform: scale(1.1); }
  .listening { background: lime !important; box-shadow: 0 0 60px lime !important; }

  /* --- CHAT --- */
  #console { flex: 1; background: #0a0a0a; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  .msg { padding: 10px 15px; border-radius: 8px; max-width: 85%; line-height: 1.4; font-size: 16px; }
  .user { align-self: flex-end; background: #222; border: 1px solid #444; }
  .ai { align-self: flex-start; border: 1px solid #444; color: #ccc; }
  
  /* --- CONTROLS --- */
  #controls { padding: 15px; background: #111; border-top: 1px solid #333; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
  #input-row { display: flex; gap: 10px; margin-bottom: 10px; }
  #txt-input { flex: 1; padding: 12px; border-radius: 8px; background: #000; border: 1px solid #444; color: white; font-size: 16px; }
  #send-btn { width: 50px; background: #222; color: cyan; border: 1px solid #333; border-radius: 8px; font-size: 20px; }
  #mic-btn { width: 100%; padding: 15px; background: #222; color: #fff; border: 1px solid #444; border-radius: 8px; font-size: 16px; }
  #mic-btn.active { background: #004400; border-color: lime; }

  /* --- CAMERA & PREVIEW --- */
  #camera-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 50; flex-direction: column; align-items: center; justify-content: center; }
  video { width: 100%; height: 100%; object-fit: cover; }
  #snap-btn { position: absolute; bottom: 50px; width: 70px; height: 70px; background: #fff; border-radius: 50%; border: 4px solid #ccc; }
  #image-preview { display: none; width: 60px; height: 60px; border: 1px solid cyan; background-size: cover; border-radius: 6px; }
</style>
</head>
<body>

<div id="boot-screen">
    <button id="start-btn" onclick="bootSystem()">START HELIX</button>
    <div style="margin-top:20px; color:#666; font-size:12px;">System Ready</div>
</div>

<div id="app" style="display:none; height:100%; flex-direction:column;">
    
    <div id="header-row">
        <button id="key-btn" onclick="askForKey()">[ API KEY ]</button>
        <span style="font-weight:900; letter-spacing:2px; color:#444;">HELIX</span>
        <button id="reset-btn" onclick="wipeMemory()">RESET</button>
    </div>

    <div id="scene">
        <div id="core"><span id="core-text">ONLINE</span></div>
        <div id="camera-container">
            <video id="cam-feed" autoplay playsinline></video>
            <div id="snap-btn" onclick="snapPhoto()"></div>
        </div>
    </div>

    <div id="console"></div>

    <div id="controls">
        <div id="image-preview" onclick="clearImage()"></div>
        
        <div id="input-row">
            <button onclick="toggleCamera()" style="background:#222; border:1px solid #444; color:#fff; width:45px; border-radius:8px;">üì∑</button>
            <input id="txt-input" placeholder="Type..." onkeydown="if(event.key==='Enter') sendText()">
            <button id="send-btn" onclick="sendText()">‚û§</button>
        </div>
        <button id="mic-btn" onclick="toggleMic()">üéôÔ∏è TAP TO SPEAK</button>
    </div>

</div>

<canvas id="cam-canvas" style="display:none;"></canvas>

<script>
// --- CONFIG ---
const MODEL = "gemini-2.5-flash";
const VOICE_KEY = "e270a037075fafc2f00f56b6f3148de92802dac819a990274d4e8bdc8fa3435a";
const VOICE_ID = "21m00Tcm4TlvDq8ikWAM";

// --- VARS ---
let googleKey = localStorage.getItem("helix_key") || "";
let history = [];
let audioCtx = null;
let currentImage = null;
let recognition = null;
let isListening = false;

// --- BOOT ---
function bootSystem() {
    // 1. Hide Boot Screen
    document.getElementById('boot-screen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    // 2. Init Audio Context (Unlock Sound)
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let osc = audioCtx.createOscillator();
    osc.connect(audioCtx.destination);
    osc.start(); osc.stop(); // Silent beep to unlock
    
    // 3. Check Key
    if(googleKey.length < 10) {
        setTimeout(askForKey, 500);
    } else {
        addMsg("ai", "Systems Active. Ready.");
    }
}

// --- KEY MANAGEMENT ---
function askForKey() {
    let k = prompt("Paste Google Gemini Key:");
    if(k && k.length > 10) {
        googleKey = k.trim();
        localStorage.setItem("helix_key", googleKey);
        alert("Key Saved!");
        addMsg("sys", "API Key Connected.");
    }
}

function wipeMemory() {
    if(confirm("Reset everything?")) {
        localStorage.clear();
        location.reload();
    }
}

// --- CHAT LOGIC ---
async function sendText() {
    let txt = document.getElementById('txt-input').value.trim();
    if(!txt && !currentImage) return;
    
    if(!googleKey) { askForKey(); return; }

    // UI Updates
    document.getElementById('txt-input').value = "";
    addMsg("user", txt || "[Image]");
    setCore("thinking");

    // Prepare Payload
    let parts = [];
    if(txt) parts.push({ text: txt });
    if(currentImage) {
        parts.push({ inline_data: { mime_type: "image/jpeg", data: currentImage } });
        clearImage();
    }

    let payload = {
        contents: [...history, { role: "user", parts: parts }]
    };

    try {
        let req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${googleKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        let res = await req.json();
        
        if(res.error) throw new Error(res.error.message);
        
        let reply = res.candidates[0].content.parts[0].text;
        
        // Update History
        history.push({ role: "user", parts: parts });
        history.push({ role: "model", parts: [{ text: reply }] });
        if(history.length > 10) history = history.slice(-10);

        addMsg("ai", reply);
        setCore("talking");
        speak(reply);

    } catch(e) {
        addMsg("sys", "Error: " + e.message);
        setCore("error");
    }
}

// --- VOICE (ELEVENLABS) ---
async function speak(text) {
    let clean = text.replace(/[*#]/g, "").slice(0, 300); // Limit text
    
    try {
        let req = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
            method: "POST",
            headers: { "xi-api-key": VOICE_KEY, "Content-Type": "application/json" },
            body: JSON.stringify({ text: clean, model_id: "eleven_multilingual_v2" })
        });

        let blob = await req.blob();
        let url = URL.createObjectURL(blob);
        let audio = new Audio(url);
        
        audio.onended = () => { 
            setCore(""); 
            if(isListening) toggleMic(true); // Restart mic loop
        };
        
        await audio.play();

    } catch(e) {
        console.log("Voice failed, using robot fallback");
        let u = new SpeechSynthesisUtterance(clean);
        u.onend = () => setCore("");
        window.speechSynthesis.speak(u);
    }
}

// --- MIC ---
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;

    recognition.onresult = (e) => {
        let t = e.results[0][0].transcript;
        document.getElementById('txt-input').value = t;
        sendText();
    };

    recognition.onend = () => {
        if(isListening) recognition.start(); // Auto-restart
        else {
            document.getElementById('mic-btn').classList.remove('active');
            document.getElementById('mic-btn').innerText = "üéôÔ∏è TAP TO SPEAK";
        }
    };
}

function toggleMic(forceStart = false) {
    if(!recognition) return alert("No Mic Support");
    
    if(isListening && !forceStart) {
        isListening = false;
        recognition.stop();
        setCore("");
    } else {
        isListening = true;
        recognition.start();
        setCore("listening");
        document.getElementById('mic-btn').classList.add('active');
        document.getElementById('mic-btn').innerText = "üõë LISTENING...";
    }
}

// --- CAMERA ---
async function toggleCamera() {
    let cam = document.getElementById('camera-container');
    if(cam.style.display === 'flex') {
        cam.style.display = 'none';
    } else {
        let stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('cam-feed').srcObject = stream;
        cam.style.display = 'flex';
    }
}

function snapPhoto() {
    let v = document.getElementById('cam-feed');
    let c = document.getElementById('cam-canvas');
    c.width = v.videoWidth; c.height = v.videoHeight;
    c.getContext('2d').drawImage(v, 0, 0);
    currentImage = c.toDataURL('image/jpeg').split(',')[1];
    
    v.srcObject.getTracks().forEach(t => t.stop()); // Stop cam
    document.getElementById('camera-container').style.display = 'none';
    
    let p = document.getElementById('image-preview');
    p.style.display = 'block';
    p.style.backgroundImage = `url(${c.toDataURL('image/jpeg')})`;
}

function clearImage() {
    currentImage = null;
    document.getElementById('image-preview').style.display = 'none';
}

// --- UI HELPERS ---
function addMsg(cls, txt) {
    let div = document.createElement('div');
    div.className = "msg " + cls;
    div.innerText = txt;
    document.getElementById('console').appendChild(div);
    document.getElementById('console').scrollTop = 99999;
}

function setCore(state) {
    let c = document.getElementById('core');
    c.className = state;
    document.getElementById('core-text').innerText = state ? state.toUpperCase() : "ONLINE";
}
</script>
</body>
</html>
