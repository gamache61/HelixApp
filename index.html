<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
<title>Helix v47.5 - Final</title>
<style>
  body { background: #000; color: #fff; font-family: -apple-system, sans-serif; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
  #scene { height: 25%; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); border-bottom: 1px solid #333; position: relative; }
  #core { width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #fff, #0ff, #001); border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; transition: 0.3s; animation: float 6s infinite ease-in-out; }
  #core.listening { background: radial-gradient(circle, #fff, #5f5, #010) !important; box-shadow: 0 0 60px lime !important; }
  #core.thinking { background: radial-gradient(circle, #fff, #fb0, #420) !important; box-shadow: 0 0 50px orange !important; }
  #core.talking { background: radial-gradient(circle, #fff, #a0f, #205) !important; box-shadow: 0 0 60px #a0f !important; }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  #ui-layer { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #0a0a0a; overflow: hidden; }
  #console { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; }
  .msg { padding: 12px; border-radius: 12px; font-size: 15px; max-width: 90%; line-height: 1.4; }
  .user { align-self: flex-end; background: #222; }
  .ai { align-self: flex-start; border: 1px solid #333; width: 100%; }
  .code-block { background: #111; padding: 10px; border-radius: 6px; font-family: monospace; color: #0f0; white-space: pre-wrap; margin-top: 5px; border: 1px solid #333; }
  #settings-panel { display: none; position: absolute; inset: 0; background: #000; z-index: 999; flex-direction: column; padding: 30px; align-items: center; }
  #settings-panel.active { display: flex; }
  .key-input { width: 100%; padding: 15px; margin: 10px 0; background: #111; border: 1px solid #444; color: #fff; border-radius: 10px; text-align: center; }
  #controls { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
  #preview { display: none; width: 60px; height: 60px; border: 1px solid cyan; background-size: cover; border-radius: 8px; }
  #input-row { display: flex; gap: 8px; }
  #txt-input { flex-grow: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #111; color: #fff; font-size: 16px; }
  .action-btn { width: 50px; height: 50px; background: #222; border: 1px solid #333; border-radius: 12px; color: #fff; font-size: 20px; cursor: pointer; }
  #mic-btn.active { background: #060; border-color: lime; box-shadow: 0 0 15px lime; }
  #camera-container { display: none; position: absolute; inset: 0; background: #000; z-index: 100; }
  video { width: 100%; height: 100%; object-fit: cover; }
  #cam-btn { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 5px solid #333; }
</style>
</head>
<body>

<div id="settings-panel">
    <h2 style="color:cyan;">HELIX v47.5</h2>
    <input type="text" id="gk-field" class="key-input" placeholder="Google API Key">
    <input type="text" id="ek-field" class="key-input" placeholder="ElevenLabs Key">
    <button onclick="saveSettings()" style="width:100%; padding:20px; background:cyan; border:none; border-radius:10px; font-weight:bold; color:black;">SAVE & REFRESH</button>
</div>

<div id="camera-container"><video id="cam-feed" autoplay playsinline></video><button id="cam-btn" onclick="snapPhoto()"></button></div>
<div id="scene"><div id="core"><span id="orb-text">HELIX</span></div></div>

<div id="ui-layer">
    <div style="display:flex; justify-content:space-between; font-size:10px; color:#555; padding:0 10px;"><span id="badge">V47.5</span><span onclick="toggleSettings()" style="cursor:pointer; color:cyan;">SETTINGS âš™</span></div>
    <div id="console"></div>
    <div id="controls">
        <div id="preview" onclick="clearImg()"></div>
        <div id="input-row">
            <input id="txt-input" placeholder="Message..." onkeydown="if(event.key==='Enter') send()">
            <button id="mic-btn" class="action-btn" onclick="toggleMic()">ðŸŽ¤</button>
            <button class="action-btn" onclick="send()" style="color:cyan;">â–¶</button>
        </div>
        <button onclick="startCam()" style="background:#111; color:#888; border:1px solid #333; padding:10px; border-radius:10px;">ðŸ“· SCAN CODE</button>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let gKey = localStorage.getItem('h_gk_v47') || "";
let eKey = localStorage.getItem('h_ek_v47') || "";
let micOn = false, rec = null, stream = null, imgData = null;

window.onload = () => {
    document.getElementById('gk-field').value = gKey;
    document.getElementById('ek-field').value = eKey;
    if(!gKey) toggleSettings();
};

function toggleSettings() { document.getElementById('settings-panel').classList.toggle('active'); }
function saveSettings() {
    gKey = document.getElementById('gk-field').value.trim();
    eKey = document.getElementById('ek-field').value.trim();
    localStorage.setItem('h_gk_v47', gKey);
    localStorage.setItem('h_ek_v47', eKey);
    location.reload(); // Force refresh to clear any stuck network states
}

// Unified Resilient Fetch (The Network Error Fix)
async function hFetch(url, opts) {
    try {
        const response = await fetch(url, {
            ...opts,
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-cache'
        });
        if (!response.ok) {
            const errBody = await response.json();
            throw new Error(errBody.error?.message || `HTTP ${response.status}`);
        }
        return response;
    } catch (e) {
        throw new Error(e.message === "Failed to fetch" ? "Network Blocked. Check Signal/VPN." : e.message);
    }
}

if ('webkitSpeechRecognition' in window) {
    rec = new webkitSpeechRecognition();
    rec.onstart = () => { orb('listening', 'LISTENING'); document.getElementById('mic-btn').classList.add('active'); };
    rec.onend = () => { document.getElementById('mic-btn').classList.remove('active'); orb('', 'HELIX'); micOn = false; };
    rec.onresult = (e) => { document.getElementById('txt-input').value = e.results[0][0].transcript; send(); };
}

function toggleMic() { if(!micOn) { micOn = true; rec.start(); } else { rec.stop(); } }

async function send() {
    const i = document.getElementById('txt-input'); const t = i.value.trim();
    if(!t && !imgData) return;
    i.value = ""; addMsg('user', t || "[Code Scan]"); orb('thinking', 'THINKING');
    
    try {
        let p = []; if(t) p.push({text:t});
        if(imgData) p.push({inline_data:{mime_type:"image/jpeg", data:imgData}});
        
        const r = await hFetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${gKey}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({contents:[{role:'user', parts:p}]})
        });
        
        const d = await r.json();
        const msg = d.candidates[0].content.parts[0].text;
        imgData = null; document.getElementById('preview').style.display = 'none';
        addMsg('ai', msg); orb('', 'HELIX'); speak(msg);
    } catch(e) { 
        addMsg('ai', `âš ï¸ ${e.message}`); 
        orb('', 'HELIX'); 
    }
}

async function speak(t) {
    let c = t.replace(/```[\s\S]*?```/g, " [code] ").replace(/[*#]/g, '').slice(0, 500);
    orb('talking', 'SPEAKING');
    if(eKey) {
        try {
            const r = await hFetch("https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM", {
                method:"POST",
                headers:{"xi-api-key":eKey, "Content-Type":"application/json"},
                body: JSON.stringify({text:c, model_id:"eleven_turbo_v2_5"})
            });
            const a = new Audio(URL.createObjectURL(await r.blob()));
            a.onended = () => orb('', 'HELIX');
            a.play(); return;
        } catch(e) {}
    }
    const u = new SpeechSynthesisUtterance(c);
    u.onend = () => orb('', 'HELIX');
    window.speechSynthesis.speak(u);
}

function orb(c, t) { const o = document.getElementById('core'); o.className = c; document.getElementById('orb-text').innerText = t; }
function addMsg(r, t) {
    const c = document.getElementById('console'); const m = document.createElement('div');
    m.className = 'msg ' + r; m.innerHTML = t.replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>');
    c.appendChild(m); c.scrollTop = c.scrollHeight;
}
function startCam() { navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s => { stream = s; document.getElementById('cam-feed').srcObject = s; document.getElementById('camera-container').style.display = 'block'; }); }
function snapPhoto() {
    const v = document.getElementById('cam-feed'); const can = document.getElementById('canvas');
    can.width = v.videoWidth; can.height = v.videoHeight; can.getContext('2d').drawImage(v, 0, 0);
    imgData = can.toDataURL('image/jpeg', 0.8).split(',')[1];
    document.getElementById('preview').style.backgroundImage = `url(${can.toDataURL('image/jpeg')})`;
    document.getElementById('preview').style.display = 'block';
    stream.getTracks().forEach(t => t.stop()); document.getElementById('camera-container').style.display = 'none';
}
function clearImg() { imgData = null; document.getElementById('preview').style.display = 'none'; }
</script>
</body>
</html>
